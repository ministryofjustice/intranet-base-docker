# <img alt="MoJ logo" src="https://www.gov.uk/assets/collections/govuk_publishing_components/crests/org_crest_18px-7026afebba9918a0830ebf68cf496cbb0b81f3514b884dc2c32904780baa3368.png" width="30">&nbsp;&nbsp; MoJ Intranet ~ Base Image

[![repo standards badge](https://img.shields.io/badge/dynamic/json?labelColor=1d1d1d&color=005ea5&style=for-the-badge&logo=data:image/png;base64,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&label=MoJ%20Compliant&query=%24.result&url=https%3A%2F%2Foperations-engineering-reports.cloud-platform.service.justice.gov.uk%2Fapi%2Fv1%2Fcompliant_public_repositories%2Fintranet-base-docker)](https://operations-engineering-reports.cloud-platform.service.justice.gov.uk/public-github-repositories.html#intranet-base-docker)
[![License](https://img.shields.io/github/license/ministryofjustice/intranet-base-docker?style=for-the-badge)](https://github.com/ministryofjustice/intranet-base-docker/blob/main/LICENSE)

## Intended Usage

This docker image is intended to be used as a base that's extended from when creating  WordPress applications that follow the [Twelve-Factor App](http://12factor.net/) philosophy.

Within MOJ Digital, we are using this as part of our Publishing Platform. It is just one piece of a larger puzzle, and so it's not particularly useful on its own.

This image expects that you're using [Bedrock](https://roots.io/bedrock/) to structure your application. The base directory for application files is `/bedrock`, meaning the webroot should be located at `/bedrock/web`, and the themes directory at `/bedrock/web/app/themes`. WordPress core should be installed using `composer` and located in `/bedrock/web/wp`.

## Environment Variables

This image accepts the following environment variables. All are optional unless otherwise stated.

**Note:** The WordPress application that extends this image will require additional environment variables. Those documented below are just required by this base image.

### Server configuration

| Name            | Required | Description |
| --------------- | -------- | ----------- |
| `SERVER_NAME`   | Yes      | Name of the website. This will be available in PHP as `$_SERVER['SERVER_NAME']`, and should usually be the hostname of the website – e.g. `www.example.com` |
| `XDEBUG_CONFIG` |          | XDebug will be enabled if this is set. It should be a string of config settings that will be used by XDebug. Usually you'll only need to set the remote host for debugging – since this is docker, you'll need to use the IP address of your host machine (`localhost` will not work!). [Refer to the documentation](https://xdebug.org/docs/all_settings) for more settings. Example: `remote_host=172.22.5.156` |

### AWS file storage

Configuration for storage of file uploads in the WordPress media library.

| Name                    | Required | Description |
| ----------------------- | -------- | ----------- |
| `AWS_S3_BUCKET`         |          | Name of the S3 bucket to use for file uploads. If not set, S3 will not be mounted. |
| `AWS_ACCESS_KEY_ID`     |          | AWS access key ID. Must have permission to read/write to the specified S3 bucket, and optionally pub/sub to SNS and SQS. |
| `AWS_SECRET_ACCESS_KEY` |          | AWS secret access key |
| `AWS_DEFAULT_REGION`    |          | Default region when creating resources. Used by yas3fs when creating SQS queues. |
| `S3_UPLOADS_BASE_URL`   |          | URL to the `uploads` directory in the S3 bucket, without a trailing slash – e.g. `https://s3-eu-west-1.amazonaws.com/example-bucket/uploads` |
| `SNS_TOPIC`             |          | ARN for SNS topic – e.g. `arn:aws:sns:eu-west-1:123456789012:topic-name`. If not set, SNS/SQS will not be used. |

### Mail configuration

SMTP settings to use for outgoing emails.

| Name                | Required | Description |
| ------------------- | -------- | ----------- |
| `SMTP_HOST`         | Yes      | SMTP server hostname – e.g. `smtp.gmail.com` |
| `SMTP_PORT`         |          | SMTP port. Defaults to port `25`. |
| `SMTP_USER`         |          | SMTP username |
| `SMTP_PASS`         |          | SMTP password |
| `SMTP_USE_STARTTLS` |          | Set to `true` to connect using STARTTLS. |
| `SMTP_USE_SSL`      |          | Set to `true` to connect using SSL. <br/> **Top Tip:** When using SSL, you'll probably want to set `SMTP_PORT` to `465`. |

### IP whitelisting

| Name                  | Required | Description |
| --------------------- | -------- | ----------- |
| `LB_IP_RANGE`         |          | The IP range of the load balancers. Used by [nginx real-ip module](https://nginx.org/en/docs/http/ngx_http_realip_module.html) for setting the real client IP, to allow whitelists to work correctly. <br/> **Important:** Only set this when the docker container is running behind a load balancer! |
| `LOGIN_WHITELIST_IPS` |          | A comma-separated list of IP addresses that should be allowed to access the WordPress login page (`/wp/wp-login.php`) |
| `SITE_WHITELIST_IPS`  |          | A comma-separated list of IP addresses to whitelist the entire website. Disabled by default – i.e. the website will be publicly accessible. |

### Example env file

```ini
# Server configuration
SERVER_NAME=example.com

# AWS file storage
AWS_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE
AWS_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
AWS_DEFAULT_REGION=eu-west-1
AWS_S3_BUCKET=example-bucket
S3_UPLOADS_BASE_URL=https://s3-eu-west-1.amazonaws.com/example-bucket/uploads
SNS_TOPIC=arn:aws:sns:eu-west-1:123456789012:example-topic

# Mail configuration
SMTP_HOST=smtp.example.com
SMTP_USER=username
SMTP_PASS=secret
SMTP_USE_STARTTLS=true

# IP whitelisting
LB_IP_RANGE=192.168.1.0/24
LOGIN_WHITELIST_IPS=192.168.99.1,93.184.216.34
```
